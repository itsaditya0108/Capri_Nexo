<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Register</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>

    <div class="container">
        <h2>Register</h2>

        <form id="registerForm">
            <input id="name" placeholder="Full Name" required />
            <input id="email" placeholder="Email" required />
            <input id="phone" placeholder="Mobile Number" maxlength="10" required />
            <div class="password-container">
                <input id="password" type="password" placeholder="Password" required />
            </div>
            <div class="password-container">
                <input id="confirmPassword" type="password" placeholder="Re-enter Password" required />
                <span id="toggleConfirmPassword" class="password-toggle" title="Show Password">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 4.5z">
                        </path>
                        <line x1="1" y1="1" x2="23" y2="23"></line>
                    </svg>
                </span>
            </div>
            <button type="submit">Register</button>
        </form>

        <div id="result" class="info"></div>

        <div class="info">
            Already have an account?
            <a href="login.html">Login</a>
        </div>
    </div>

    <script>
        // =======================
        // ELEMENT REFERENCES
        // =======================
        const registerForm = document.getElementById("registerForm");
        const result = document.getElementById("result");
        const registerBtn = registerForm.querySelector("button");

        const nameInput = document.getElementById("name");
        const emailInput = document.getElementById("email");
        const phoneInput = document.getElementById("phone");
        const passwordInput = document.getElementById("password");

        const confirmPasswordInput = document.getElementById("confirmPassword");
        const toggleConfirmPassword = document.getElementById("toggleConfirmPassword");

        // =======================
        // VALIDATION HELPERS
        // =======================

        function isValidEmail(email) {
            return /^[a-zA-Z0-9._%+-]+@gmail\.com$/.test(email);
        }

        function isValidPhone(phone) {
            return /^[6-9]\d{9}$/.test(phone);
        }

        function validatePassword(password) {
            if (typeof password !== "string") {
                return "Invalid password";
            }

            if (password.length < 8) {
                return "Password must be at least 8 characters";
            }

            if (password.length > 72) {
                return "Password too long";
            }

            if (/\s/.test(password)) {
                return "Password cannot contain spaces";
            }

            if (!/[A-Z]/.test(password)) {
                return "Add at least one uppercase letter";
            }

            if (!/[a-z]/.test(password)) {
                return "Add at least one lowercase letter";
            }

            if (!/[0-9]/.test(password)) {
                return "Add at least one number";
            }

            if (!/[^\w\s]/.test(password)) {
                return "Add at least one special character";
            }

            return null; // âœ… VALID
        }


        // =======================
        // REAL-TIME VALIDATION
        // =======================

        function setValidationStatus(input, isValid, errorMessage) {
            // Remove existing status
            input.classList.remove("input-error", "input-success");
            const nextSibling = input.nextElementSibling;
            if (nextSibling && nextSibling.classList.contains("field-error-msg")) {
                nextSibling.remove();
            }
            if (input.parentElement.classList.contains("password-container")) {
                const parentNext = input.parentElement.nextElementSibling;
                if (parentNext && parentNext.classList.contains("field-error-msg")) {
                    parentNext.remove();
                }
            }

            if (isValid) {
                input.classList.add("input-success");
            } else {
                if (errorMessage) {
                    input.classList.add("input-error");
                    const errorDiv = document.createElement("div");
                    errorDiv.className = "field-error-msg";
                    errorDiv.innerHTML = `<svg style="width:12px;height:12px;fill:currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg> ${errorMessage}`;

                    if (input.parentElement.classList.contains("password-container")) {
                        input.parentElement.insertAdjacentElement('afterend', errorDiv);
                    } else {
                        input.insertAdjacentElement('afterend', errorDiv);
                    }
                }
            }
        }

        nameInput.addEventListener("input", function () {
            const val = this.value.trim();
            if (val.length === 0) {
                setValidationStatus(this, false, null); // Clear
            } else if (!/^[A-Za-z ]+$/.test(val)) {
                setValidationStatus(this, false, "Name must contain only letters");
            } else if (val.length < 3) {
                setValidationStatus(this, false, null);
            } else {
                setValidationStatus(this, true);
            }
        });

        nameInput.addEventListener("blur", function () {
            const val = this.value.trim();
            if (val.length > 0 && val.length < 3) {
                setValidationStatus(this, false, "Name must be at least 3 characters");
            }
        });

        emailInput.addEventListener("input", function () {
            const val = this.value.trim();
            if (val.length === 0) {
                setValidationStatus(this, false, null);
            } else if (isValidEmail(val)) {
                setValidationStatus(this, true);
            } else {
                setValidationStatus(this, false, null);
            }
        });

        emailInput.addEventListener("blur", function () {
            const val = this.value.trim();
            if (val.length > 0 && !isValidEmail(val)) {
                setValidationStatus(this, false, "Email must be a valid gmail.com address");
            }
        });

        phoneInput.addEventListener("input", function () {
            this.value = this.value.replace(/\D/g, "");
            const val = this.value;
            if (val.length === 10 && isValidPhone(val)) {
                setValidationStatus(this, true);
            } else {
                setValidationStatus(this, false, null);
            }
        });

        phoneInput.addEventListener("blur", function () {
            const val = this.value;
            if (val.length > 0 && (val.length !== 10 || !isValidPhone(val))) {
                setValidationStatus(this, false, "Enter a valid 10-digit mobile number");
            }
        });

        passwordInput.addEventListener("input", function () {
            const val = this.value;
            if (!val) {
                setValidationStatus(this, false, null);
                return;
            }
            const error = validatePassword(val);
            if (!error) {
                setValidationStatus(this, true);
            } else {
                setValidationStatus(this, false, error);
            }
        });

        confirmPasswordInput.addEventListener("input", function () {
            const val = this.value;
            if (!val) {
                setValidationStatus(this, false, null);
            } else if (val !== passwordInput.value) {
                setValidationStatus(this, false, "Passwords do not match");
            } else {
                setValidationStatus(this, true);
            }
        });


        // =======================
        // PASSWORD TOGGLE
        // =======================

        const eyeIcon = `
            <svg viewBox="0 0 24 24">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
            </svg>
        `;

        const eyeSlashIcon = `
            <svg viewBox="0 0 24 24">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 4.5z"></path>
                <line x1="1" y1="1" x2="23" y2="23"></line>
            </svg>
        `;



        toggleConfirmPassword.addEventListener("click", function () {
            const isHidden = confirmPasswordInput.type === "password";
            confirmPasswordInput.type = isHidden ? "text" : "password";
            this.innerHTML = isHidden ? eyeIcon : eyeSlashIcon;
        });

        // =======================
        // DEVICE CONTEXT
        // =======================

        if (!localStorage.getItem("webDeviceId")) {
            const uuid = (crypto.randomUUID && crypto.randomUUID()) ||
                (Math.random().toString(36).substring(2) + Date.now().toString(36));
            localStorage.setItem("webDeviceId", uuid);
        }

        function getLocation() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    resolve(null);
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        resolve({
                            latitude: pos.coords.latitude,
                            longitude: pos.coords.longitude,
                            accuracy: Math.round(pos.coords.accuracy)
                        });
                    },
                    (err) => {
                        console.warn("Geolocation error:", err.message);
                        resolve(null);
                    },
                    { timeout: 5000, enableHighAccuracy: true }
                );
            });
        }

        async function buildDeviceContext() {
            const location = await getLocation();
            return {
                deviceId: "web-" + localStorage.getItem("webDeviceId"),
                deviceType: "BROWSER",
                manufacturer: "Browser",
                deviceModel: navigator.userAgent.includes("Android")
                    ? "Android Chrome"
                    : (navigator.userAgent.includes("iPhone") ? "iPhone Safari" : "Desktop Browser"),
                os: navigator.platform,
                osVersion: navigator.appVersion,
                appVersion: "1.0.0-web",
                networkType: navigator.connection ? navigator.connection.effectiveType : "unknown",
                location: location
            };
        }

        // =======================
        // FORM SUBMISSION
        // =======================

        registerForm.addEventListener("submit", async function (e) {
            e.preventDefault();

            const name = nameInput.value.trim();
            const email = emailInput.value.trim();
            const phone = phoneInput.value.trim();
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            let hasError = false;

            // Final check on submit
            if (name.length < 3 || !/^[A-Za-z ]+$/.test(name)) {
                setValidationStatus(nameInput, false, "Invalid Name");
                hasError = true;
            }
            if (!isValidEmail(email)) {
                setValidationStatus(emailInput, false, "Invalid Email");
                hasError = true;
            }
            if (!isValidPhone(phone)) {
                setValidationStatus(phoneInput, false, "Invalid Phone");
                hasError = true;
            }
            const passErr = validatePassword(password);
            if (passErr) {
                setValidationStatus(passwordInput, false, passErr);
                hasError = true;
            }
            if (password !== confirmPassword) {
                setValidationStatus(confirmPasswordInput, false, "Passwords do not match");
                hasError = true;
            }

            if (hasError) return;

            // ---- Prevent double submit
            registerBtn.disabled = true;
            registerBtn.innerText = "Processing...";

            try {
                const deviceContext = await buildDeviceContext();

                const response = await fetch("api/auth/register", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        name,
                        email,
                        phone,
                        password,
                        deviceContext: deviceContext
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    if (data.errorCode === "EMAIL_EXISTS") {
                        setValidationStatus(emailInput, false, "Email is already registered");
                    } else if (data.errorCode === "PHONE_ALREADY_EXISTS") {
                        setValidationStatus(phoneInput, false, "Phone number is already registered");
                    } else if (data.errorCode === "REGISTRATION_FAILED") {
                        result.innerHTML = `<span class="error">Registration failed. Please try again.</span>`;
                    } else {
                        result.innerHTML = `<span class="error">${data.errorMessage || "Registration failed"}</span>`;
                    }
                    return;
                }

                sessionStorage.setItem("email", email);
                window.location.href = "verify-otp.html";

            } catch (error) {
                console.error(error);
                result.innerHTML = `<span class="error">Network error. Please try again.</span>`;
            } finally {
                registerBtn.disabled = false;
                registerBtn.innerText = "Register";
            }
        });
    </script>

</body>

</html>