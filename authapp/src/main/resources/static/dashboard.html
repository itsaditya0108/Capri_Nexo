<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capri Nexo</title>
    <link rel="stylesheet" href="css/dashboard.css?v=hero2">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</head>

<body>
    <style>
        /* NEW IMAGES CSS */
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .image-grid img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
        }

        .modal {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
            z-index: 1001;
        }

        .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
        }

        .image-wrapper {
            position: relative;
        }

        .trash-icon {
            position: absolute;
            top: 6px;
            right: 6px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 50%;
            padding: 4px 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .trash-icon:hover {
            background: rgba(255, 0, 0, 0.8);
        }

        /* LAYOUT FIXES For Chat View */
        #view-chat {
            display: flex;
            /* Critical for side-by-side layout */
            height: 100%;
            overflow: hidden;
            width: 100%;
        }

        #chatSidebar {
            width: 320px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            background: #fff;
            flex-shrink: 0;
        }

        #chatMain {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
            min-width: 0;
            /* Prevents flex overflow */
            position: relative;
        }

        /* Mobile Responsive Overrides */
        @media (max-width: 768px) {
            #view-chat {
                display: block;
                /* Stack on mobile */
                position: relative;
            }

            #chatSidebar {
                width: 100%;
                height: 100%;
                display: flex;
                /* Always show sidebar by default */
            }

            #chatMain {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 20;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                display: flex;
                /* Keep layout internal to main */
                background: #fff;
            }

            #chatMain.active {
                transform: translateX(0);
            }
        }
    </style>

    <!-- SIDEBAR (Desktop) -->
    <div class="sidebar">
        <div class="brand">capri <span>nexo</span></div>
        <ul class="nav-links">
            <li class="nav-item active" onclick="switchView('dashboard', this)">
                <ion-icon name="people-outline"></ion-icon>
                <span>Groupchat</span>
            </li>
            <li class="nav-item" onclick="switchView('images', this)">
                <ion-icon name="images-outline"></ion-icon>
                <span>Images</span>
            </li>

            <li class="nav-item" onclick="switchView('chat', this)">
                <ion-icon name="chatbubble-ellipses-outline"></ion-icon>
                <span>Messages</span>
            </li>
            <li class="nav-item" onclick="switchView('profile', this)">
                <ion-icon name="person-outline"></ion-icon>
                <span>Profile</span>
            </li>
        </ul>
        <div class="user-profile-summary" onclick="switchView('profile', document.querySelectorAll('.nav-item')[3])">
            <img id="navAvatarImg" src=""
                style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; display: none;" />
            <div class="avatar-small" id="navAvatar">U</div>
            <div style="font-weight: 600; font-size: 14px;" id="navName">User</div>
        </div>
    </div>

    <!-- BOTTOM NAV (Mobile) -->
    <div class="bottom-nav">
        <div class="bottom-nav-item active" onclick="switchView('dashboard', this, true)">
            <ion-icon name="people-outline"></ion-icon>
        </div>
        <div class="bottom-nav-item" onclick="switchView('images', this, true)">
            <ion-icon name="images-outline"></ion-icon>
        </div>

        <div class="bottom-nav-item" onclick="switchView('chat', this, true)">
            <ion-icon name="chatbubble-ellipses-outline"></ion-icon>
        </div>
        <div class="bottom-nav-item" onclick="switchView('profile', this, true)">
            <ion-icon name="person-outline"></ion-icon>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">

        <!-- GROUPCHAT VIEW (Renamed from Dashboard) -->
        <div id="view-dashboard" class="view-container">

            <div id="groupList" class="conversation-list"></div>

            <!-- HERO QUOTES SECTION -->
            <div id="dashboardHero" class="dashboard-hero">
                <p class="hero-line-1">Capture every moment.</p>
                <p class="hero-line-2">Auth and real-time chat secured first.</p>
                <p class="hero-line-3">Image gallery is coming next...</p>
            </div>
        </div>

        <!-- IMAGES VIEW -->
        <div id="view-images" class="view-container hidden">
            <div class="card">
                <h2>Your Images</h2>

                <div class="upload-controls">
                    <!-- Group 1: Standard Upload -->
                    <div class="control-group">
                        <label>Upload Images</label>
                        <div class="input-row">
                            <input type="file" id="imageUploadInput" multiple accept="image/*" />
                            <button class="btn btn-primary" onclick="uploadImages()">
                                <ion-icon name="cloud-upload-outline"></ion-icon> Upload
                            </button>
                        </div>
                    </div>

                    <!-- Group 2: Sync Folder -->
                    <div class="control-group">
                        <label>Sync Folder</label>
                        <div class="input-row">
                            <input type="file" id="folderPicker" webkitdirectory multiple accept="image/*" />
                            <button class="btn btn-secondary" onclick="startSync()">
                                <ion-icon name="sync-outline"></ion-icon> Sync
                            </button>
                        </div>
                    </div>

                    <span id="syncStatus"
                        style="display:block; width:100%; margin-top:5px; font-size:13px; color:var(--text-secondary);"></span>
                </div>

                <div id="imageGrid" class="image-grid"></div>
            </div>
        </div>


        <!-- MESSAGES VIEW -->
        <div id="view-chat" class="view-container hidden">
            <!-- Sidebar for chats -->
            <div class="chat-sidebar" id="chatSidebar">
                <div class="header">
                    <h2>Direct</h2>
                    <button class="btn btn-primary" onclick="startNewChat(event)">New Chat</button>
                    <!-- New Chat Box -->
                    <div id="newChatBox" class="new-chat-box hidden">
                        <input type="text" id="userSearchInput" class="form-input" placeholder="Search user..." />
                        <div id="userSearchResults"></div>
                    </div>
                </div>

                <div class="conversation-list" id="conversationList"></div>
            </div>

            <!-- Chat Main -->
            <div class="chat-main" id="chatMain">
                <!-- Mobile Back Header -->
                <!-- Chat Header -->
                <div class="chat-header">
                    <button class="menu-btn mobile-only"
                        onclick="document.getElementById('chatMain').classList.remove('active')">
                        <ion-icon name="arrow-back-outline"></ion-icon>
                    </button>

                    <div style="display: flex; align-items: center; gap: 10px;">
                        <!-- Chat Header Avatar -->
                        <div class="user-avatar" style="width: 40px; height: 40px; cursor: pointer;"
                            onclick="openProfileImageModal()">
                            <img id="chatHeaderImg" src=""
                                style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; display: none;" />
                            <div id="chatHeaderFallback"
                                style="width: 100%; height: 100%; background: #eee; display: flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 50%;">
                            </div>
                        </div>

                        <div>
                            <div class="chat-title" id="chatHeaderName" style="font-weight: 600;">Select a chat</div>
                            <div class="chat-members" id="chatHeaderMembers"></div>
                        </div>
                    </div>

                    <div style="flex: 1;"></div>
                    <div style="position: relative;">
                        <button id="addMemberBtn" class="btn btn-secondary hidden"
                            onclick="toggleAddMemberSearch(event)">+ Add Member</button>
                        <div id="addMemberBox" class="new-chat-box hidden" style="width: 250px; right: 0;">
                            <input type="text" id="addMemberInput" class="form-input" placeholder="Search to add..." />
                            <div id="addMemberResults"></div>
                        </div>
                    </div>
                </div>

                <div class="chat-messages" id="messageList">
                    <div id="emptyState"
                        style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center;">
                        <ion-icon name="paper-plane-outline" style="font-size: 50px; margin-bottom: 12px;"></ion-icon>


                        <h3>Your Messages</h3>
                        <p style="color: grey;">Send private photos and messages to a friend or group.</p>
                        <button class="btn btn-primary" style="margin-top: 20px;" onclick="startNewChat()">Send
                            Message</button>
                    </div>
                </div>

                <div id="typingIndicator" class="typing hidden"
                    style="padding-left: 20px; font-style: italic; color: #8e8e8e; font-size: 12px; margin-bottom: 5px;">
                </div>

                <div class="chat-input-area hidden" id="inputArea">
                    <textarea id="messageInput" class="message-input" placeholder="Message..." rows="1"
                        onkeydown="handleChatInputKey(event)"></textarea>
                    <button class="send-btn-text" id="sendBtn" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>

        <!-- PROFILE VIEW -->
        <div id="view-profile" class="view-container hidden">
            <div class="card">
                <h2>Profile</h2>

                <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;">
                    <div
                        style="position: relative; width: 100px; height: 100px; background: #f0f0f0; border-radius: 50%; overflow: hidden;">
                        <img id="profileImg" src=""
                            style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;"
                            onclick="toggleProfileContext()"
                            onerror="this.style.display='none'; document.getElementById('profileMainAvatar').style.display='flex';" />
                        <div id="profileMainAvatar" onclick="toggleProfileContext()"
                            style="width: 100%; height: 100%; display: none; align-items: center; justify-content: center; font-size: 36px; font-weight: bold; color: #555; cursor: pointer;">
                        </div>
                        <div style="margin-top: 8px; font-size: 12px; color: #8e8e8e; text-align: center;"
                            id="profilePicStatusText">Loading...</div>
                    </div>
                    <div id="profileContextArea"
                        style="display: none; width: 100%; flex-direction: column; align-items: center;">
                        <div style="margin-top: 10px; display: flex; gap: 10px;">
                            <input type="file" id="profileInput" accept="image/*" style="display: none;"
                                onchange="uploadProfile()" />
                            <button class="btn btn-secondary"
                                onclick="document.getElementById('profileInput').click()">Change Photo</button>
                            <button class="btn btn-danger" onclick="deleteProfilePicture()">Remove</button>
                        </div>

                        <!-- Profile History Section -->
                        <div style="margin-top: 24px; width: 100%;">
                            <h4
                                style="margin-bottom: 12px; font-size: 14px; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">
                                Previous Pictures</h4>
                            <div id="profileHistoryGrid"
                                style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                                <!-- Items injected by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="info-row">
                    <span class="label">Full Name</span>
                    <span class="value" id="profileName">Loading...</span>
                </div>

                <div class="info-row">
                    <span class="label">Email</span>
                    <div class="value">
                        <span id="profileEmail">...</span>
                        <!-- Email verified status is usually handled via login flow, but we can show status -->
                        <span class="badge success">Verified</span>
                    </div>
                </div>

                <div class="info-row">
                    <span class="label">Phone Number</span>
                    <div class="value" style="flex-direction: column; align-items: flex-end;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="profilePhone">...</span>
                            <span id="phoneStatusBadge" class="badge warning">Unverified</span>
                        </div>
                        <div style="margin-top: 4px;">
                            <button class="btn btn-link" onclick="handlePhoneAction()" id="phoneActionBtn">Verify
                                Phone</button>
                        </div>
                    </div>
                </div>

                <div class="info-row">
                    <span class="label">Account Status</span>
                    <span class="value" id="profileStatus">Active</span>
                </div>
            </div>

            <div class="card">
                <h2>Security</h2>
                <div class="info-row">
                    <span class="label">Password</span>
                    <a href="forgot-password.html" class="btn btn-link">Change Password</a>
                </div>
                <div class="info-row">
                    <span class="label">Session</span>
                    <button class="btn text-danger" onclick="logout()" style="background: none; padding: 0;">Log
                        Out</button>
                </div>
            </div>
        </div>

    </div>

    <!-- IMAGE MODAL -->
    <div id="imageModal" class="hidden modal">
        <div class="modal-backdrop" onclick="closeImageModal()"></div>
        <div class="modal-content"
            style="position: relative; max-width: 90vw; max-height: 90vh; display: flex; align-items: center; justify-content: center;">
            <img id="modalImage" style="max-width: 100%; max-height: 100%; object-fit: contain;" />
            <div id="modalImageFallback"
                style="display: none; flex-direction: column; align-items: center; justify-content: center; background: #f0f2f5; border-radius: 12px; padding: 60px 80px; min-width: 300px;">
                <div
                    style="width: 120px; height: 120px; border-radius: 50%; background: #d1d7db; display: flex; align-items: center; justify-content: center;">
                    <ion-icon name="person-outline" style="font-size: 60px; color: #8e9297;"></ion-icon>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* ================= CONFIG ================= */
        // Allow overriding via query param for testing ?chatUrl=...
        const urlParams = new URLSearchParams(window.location.search);

        // Dynamic CHAT_BASE that works on localhost AND network (192.168.x.x)
        const hostname = window.location.hostname || 'localhost';
        const protocol = window.location.protocol || 'http:';
        const CHAT_BASE = urlParams.get("chatUrl") || `${protocol}//${hostname}:8082`;
        const AUTH_BASE = `${protocol}//${hostname}:8082/authapp`;

        const IMAGE_BASE = `${protocol}//${hostname}:8083`;
        let user = null;
        let token = null;
        let activeConversationId = null;
        let activeConversationType = null;
        let eventSource = null;
        let currentInbox = [];
        let lastDate = null;
        let inboxDebounceTimer = null; // Timer for debouncing inbox refreshes
        let globalEventSource = null;


        /* ================= INIT ================= */
        document.addEventListener("DOMContentLoaded", () => {
            const userData = sessionStorage.getItem("user");
            token = sessionStorage.getItem("accessToken");

            if (!userData || !token) {
                window.location.href = "login.html";
                return;
            }

            user = JSON.parse(userData);
            loadProfilePicture();
            hydrateUser();
            loadInbox();
            loadGroups();
            startGlobalPolling();
            initGlobalNotifications();

            // Click outside listener
            document.addEventListener("click", (e) => {
                const addMemberBox = document.getElementById("addMemberBox");
                const newChatBox = document.getElementById("newChatBox");

                if (!addMemberBox.classList.contains("hidden") &&
                    !addMemberBox.contains(e.target) &&
                    e.target.id !== "addMemberBtn") {
                    addMemberBox.classList.add("hidden");
                }

                if (!newChatBox.classList.contains("hidden") &&
                    !newChatBox.contains(e.target)) {
                    newChatBox.classList.add("hidden");
                }
            });

            // Prevent closing when clicking inside boxes
            document.getElementById("addMemberBox").addEventListener("click", e => e.stopPropagation());
            document.getElementById("newChatBox").addEventListener("click", e => e.stopPropagation());

            // Setup search input listeners
            document.getElementById("userSearchInput").addEventListener("input", handleUserSearch);
            document.getElementById("addMemberInput").addEventListener("input", handleMemberSearch);

            // GLOBAL 401 REDIRECT (CRITICAL FOR LOGOUT ON OTHER DEVICES)
            const originalFetch = window.fetch;
            window.fetch = async (...args) => {
                const response = await originalFetch(...args);
                if (response.status === 401) {
                    const url = args[0].toString();
                    // Don't redirect if it's a login/refresh attempt failing (those handle themselves)
                    if (!url.includes("/api/auth/login") && !url.includes("/api/auth/refresh")) {
                        console.warn("Session expired or revoked (401). Redirecting to login...");
                        sessionStorage.clear();
                        window.location.href = "login.html";
                    }
                }
                return response;
            };
        });

        /* ================= USER ================= */
        function getInitials(name) {
            if (!name) return "U";
            const parts = name.trim().split(/\s+/);
            if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
            return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        }

        function hydrateUser() {
            document.getElementById("navName").textContent = user.name || "User";
            document.getElementById("navAvatar").textContent = getInitials(user.name);
            const mainAvatar = document.getElementById("profileMainAvatar");
            if (mainAvatar) mainAvatar.textContent = getInitials(user.name);

            document.getElementById("profileName").textContent = user.name || "User";
            document.getElementById("profileEmail").textContent = maskEmail(user.email || "");
            document.getElementById("profilePhone").textContent = maskPhone(user.phone);
            document.getElementById("profileStatus").textContent = user.status || "Active";

            // Add Profile Picture status
            const picStatus = document.getElementById("profilePicStatus");
            if (picStatus) {
                picStatus.textContent = "Checking...";
            }
            loadProfilePictureStatus();

            const phoneBadge = document.getElementById("phoneStatusBadge");
            const phoneBtn = document.getElementById("phoneActionBtn");

            if (user.phoneVerified) {
                phoneBadge.className = "badge success";
                phoneBadge.textContent = "Verified";
                phoneBtn.textContent = "Change Phone Number";
            } else {
                phoneBadge.className = "badge warning";
                phoneBadge.textContent = "Not Verified";
                phoneBtn.textContent = "Verify Now";
            }
        }

        /* ================= NAV ================= */
        function switchView(viewId, navEl, isMobile = false) {
            ["view-dashboard", "view-chat", "view-profile", "view-images"]
                .forEach(id => document.getElementById(id)?.classList.add("hidden"));

            document.getElementById(`view-${viewId}`).classList.remove("hidden");

            if (viewId === "images") {
                loadImages(); // ðŸ”¥ auto-load images
            } else if (viewId === "profile") {
                loadProfile(); // ðŸ”¥ auto-load profile & history
            }

            document.querySelectorAll(".nav-item").forEach(el => el.classList.remove("active"));
            document.querySelectorAll(".bottom-nav-item").forEach(el => el.classList.remove("active"));

            if (navEl) navEl.classList.add("active");
        }


        /* ================= HELPERS ================= */
        function maskEmail(email) {
            if (!email) return "";
            const [n, d] = email.split("@");
            return n.slice(0, 2) + "***@" + d;
        }

        function maskPhone(p) {
            return p ? p.slice(0, 3) + "****" + p.slice(-2) : "Not Set";
        }

        /* ================= SEARCH FUNCTIONS ================= */
        let currentGroupMembers = [];

        function startNewChat(event) {
            if (event) event.stopPropagation();
            const box = document.getElementById("newChatBox");
            box.classList.toggle("hidden");
            if (!box.classList.contains("hidden")) {
                document.getElementById("userSearchInput").value = "";
                document.getElementById("userSearchResults").innerHTML = "";
                document.getElementById("userSearchInput").focus();
            }
        }

        function toggleAddMemberSearch(event) {
            if (event) event.stopPropagation();
            const box = document.getElementById("addMemberBox");
            box.classList.toggle("hidden");
            if (!box.classList.contains("hidden")) {
                document.getElementById("addMemberInput").value = "";
                document.getElementById("addMemberResults").innerHTML = "";
                document.getElementById("addMemberInput").focus();
                // Fetch current group members
                fetchGroupMembersForFilter();
            }
        }

        async function fetchGroupMembersForFilter() {
            if (!activeConversationId) return;
            try {
                const res = await fetch(`${CHAT_BASE}/api/conversations/${activeConversationId}/details`, {
                    headers: { "Authorization": "Bearer " + token }
                });
                if (res.ok) {
                    const details = await res.json();
                    currentGroupMembers = details.members || [];
                    console.log("Current group members:", currentGroupMembers);
                }
            } catch (e) {
                console.error("Failed to fetch group members", e);
            }
        }

        async function handleUserSearch(e) {
            const query = e.target.value.trim();
            const resultsDiv = document.getElementById("userSearchResults");

            if (!query) {
                resultsDiv.innerHTML = "";
                return;
            }

            try {
                const res = await fetch(`${CHAT_BASE}/api/users/search?q=${encodeURIComponent(query)}`, {
                    headers: { "Authorization": "Bearer " + token }
                });

                if (!res.ok) {
                    resultsDiv.innerHTML = "<div style='padding: 8px; color: #999;'>Error searching users</div>";
                    return;
                }

                const users = await res.json();
                renderUserSearchResults(users, resultsDiv, false);
            } catch (e) {
                console.error("User search error", e);
                resultsDiv.innerHTML = "<div style='padding: 8px; color: #999;'>Error searching users</div>";
            }
        }

        async function handleMemberSearch(e) {
            const query = e.target.value.trim();
            const resultsDiv = document.getElementById("addMemberResults");

            if (!query) {
                resultsDiv.innerHTML = "";
                return;
            }

            try {
                const res = await fetch(`${CHAT_BASE}/api/users/search?q=${encodeURIComponent(query)}`, {
                    headers: { "Authorization": "Bearer " + token }
                });

                if (!res.ok) {
                    resultsDiv.innerHTML = "<div style='padding: 8px; color: #999;'>Error searching users</div>";
                    return;
                }

                const users = await res.json();
                // Don't filter - instead mark which users are already members
                const usersWithStatus = users.map(u => ({
                    ...u,
                    isAlreadyMember: currentGroupMembers.some(m => m.userId === u.userId)
                }));
                console.log("Users with status:", usersWithStatus);
                console.log("Current group members for comparison:", currentGroupMembers);
                renderUserSearchResults(usersWithStatus, resultsDiv, true);
            } catch (e) {
                console.error("Member search error", e);
                resultsDiv.innerHTML = "<div style='padding: 8px; color: #999;'>Error searching users</div>";
            }
        }

        function renderUserSearchResults(users, container, isAddMember) {
            if (!users || users.length === 0) {
                container.innerHTML = "<div style='padding: 12px; color: #8e8e8e; font-size: 14px; text-align: center;'>No users found</div>";
                return;
            }

            container.innerHTML = users.map(u => {
                const isDisabled = isAddMember && u.isAlreadyMember;
                const cursorStyle = isDisabled ? 'cursor: not-allowed;' : 'cursor: pointer;';
                const opacityStyle = isDisabled ? 'opacity: 0.6;' : '';
                const clickHandler = isAddMember ?
                    (u.isAlreadyMember ? '' : `addMemberToGroup(${u.userId}, '${u.name.replace(/'/g, "\\'")}'`) :
                    `startDirectChat(${u.userId}, '${u.name.replace(/'/g, "\\'")}')`;

                let buttonHtml;
                if (isAddMember) {
                    if (u.isAlreadyMember) {
                        buttonHtml = '<div style="padding: 6px 16px; background: #e0e0e0; color: #8e8e8e; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: not-allowed;">Added</div>';
                    } else {
                        buttonHtml = '<div style="padding: 6px 16px; background: #fd1d1d; color: white; border-radius: 8px; font-size: 12px; font-weight: 600; box-shadow: 0 2px 6px rgba(253, 29, 29, 0.3); transition: transform 0.2s;" onmouseover="this.style.transform=\'scale(1.05)\'" onmouseout="this.style.transform=\'scale(1)\'">Add</div>';
                    }
                } else {
                    buttonHtml = '<ion-icon name="chevron-forward-outline" style="font-size: 18px; color: #8e8e8e;"></ion-icon>';
                }

                return `
                    <div class="user-search-result" 
                         style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; transition: all 0.2s ease; margin-bottom: 4px; ${cursorStyle} ${opacityStyle}"
                         onmouseover="if(!${isDisabled}) { this.style.background='#f7f7f7'; this.style.transform='translateX(2px)'; }"
                         onmouseout="this.style.background='transparent'; this.style.transform='translateX(0)'"
                         onclick="${clickHandler}">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; font-size: 14px; flex-shrink: 0;">
                            ${getInitials(u.name)}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 14px; color: #262626; margin-bottom: 2px;">${u.name}</div>
                            <div style="font-size: 12px; color: #8e8e8e; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${u.email || ""}</div>
                        </div>
                        ${buttonHtml}
                    </div>
                `;
            }).join("");
        }

        async function startDirectChat(userId, userName) {
            try {
                const res = await fetch(`${CHAT_BASE}/api/conversations/create`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify({ otherUserId: userId })
                });

                if (res.ok) {
                    const conversation = await res.json();
                    document.getElementById("newChatBox").classList.add("hidden");
                    await loadInbox();
                    openChat(conversation.conversationId);
                } else {
                    alert("Failed to create conversation");
                }
            } catch (e) {
                console.error("Error creating conversation", e);
                alert("Error creating conversation");
            }
        }

        async function addMemberToGroup(userId, userName) {
            if (!activeConversationId) return;

            try {
                const res = await fetch(`${CHAT_BASE}/api/groups/${activeConversationId}/members`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify({ userId: userId })
                });

                if (res.ok) {
                    document.getElementById("addMemberBox").classList.add("hidden");
                    fetchGroupDetails();
                    alert(`${userName} added to the group!`);
                } else {
                    const error = await res.text();
                    alert(`Failed to add member: ${error}`);
                }
            } catch (e) {
                console.error("Error adding member", e);
                alert("Error adding member to group");
            }
        }


        /* ================= LOGOUT ================= */
        async function logout() {
            const refreshToken = sessionStorage.getItem("refreshToken");

            if (refreshToken) {
                try {
                    await fetch("api/auth/logout", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": "Bearer " + token
                        },
                        body: JSON.stringify({ refreshToken })
                    });
                } catch (e) {
                    console.error(e);
                }
            }

            sessionStorage.clear();
            window.location.href = "login.html";
        }

        async function uploadProfile() {
            const fileInput = document.getElementById("profileInput");
            if (fileInput.files.length === 0) return;

            const f = fileInput.files[0];
            const fd = new FormData();
            fd.append("file", f);

            try {
                const res = await fetch(`${IMAGE_BASE}/api/profile-picture`, {
                    method: "POST",
                    headers: { "Authorization": "Bearer " + token },
                    body: fd
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    try {
                        const json = JSON.parse(errorText);
                        alert("Upload failed: " + (json.message || json.error || "Unknown error"));
                    } catch (e) {
                        alert("Upload failed: " + res.status + " " + res.statusText);
                    }
                    return;
                }

                loadProfile();

            } catch (e) {
                console.error("Upload error", e);
                alert("Upload error: " + e.message);
            }
        }

        async function loadProfile() {
            // Reload history, which triggers UI updates for main image and buttons
            loadProfileHistory();
            loadProfilePictureStatus();
        }

        async function loadProfileHistory() {
            try {
                const res = await fetch(`${IMAGE_BASE}/api/profile-picture/history`, {
                    headers: { "Authorization": "Bearer " + token }
                });

                if (res.ok) {
                    const pics = await res.json();
                    renderProfileHistory(pics);
                }
            } catch (e) {
                console.error("Failed to load history", e);
            }
        }

        function renderProfileHistory(pics) {
            const container = document.getElementById("profileHistoryGrid");
            if (!container) return;

            container.innerHTML = "";
            let activePic = null;

            if (!pics || pics.length === 0) {
                container.innerHTML = "<p style='color:#999; font-size:13px;'>No history</p>";
            } else {
                // Sort by created desc
                pics.sort((a, b) => new Date(b.createdTimestamp) - new Date(a.createdTimestamp));

                pics.forEach(pic => {
                    if (pic.active) activePic = pic;

                    const div = document.createElement("div");
                    div.className = "history-item";
                    div.style.position = "relative";
                    div.style.width = "60px";
                    div.style.height = "60px";
                    div.style.cursor = "pointer";
                    div.style.borderRadius = "50%";
                    div.style.overflow = "hidden";
                    div.style.border = pic.active ? "3px solid #007bff" : "2px solid #eee";
                    div.title = pic.active ? "Current Profile Picture" : "Click to set as active";

                    // If not active, add click handler to set active
                    if (!pic.active) {
                        div.onclick = () => setActiveProfilePicture(pic.id);
                    }

                    const img = document.createElement("img");
                    img.src = `${IMAGE_BASE}/api/profile-picture/${pic.id}/view/small?token=${encodeURIComponent(token)}`;
                    img.style.width = "100%";
                    img.style.height = "100%";
                    img.style.objectFit = "cover";

                    div.appendChild(img);
                    container.appendChild(div);
                });
            }

            // Update Main Profile UI based on history state
            updateProfileUI(activePic);
        }

        function toggleProfileContext() {
            const area = document.getElementById("profileContextArea");
            if (area) {
                area.style.display = (area.style.display === "none") ? "flex" : "none";
            }
        }

        function updateProfileUI(activePic) {
            const mainImg = document.getElementById("profileImg");
            const navImg = document.getElementById("navAvatarImg");
            const navDiv = document.getElementById("navAvatar");

            const removeBtn = document.querySelector("button[onclick='deleteProfilePicture()']");
            const changeBtn = document.querySelector("button[onclick=\"document.getElementById('profileInput').click()\"]");

            if (activePic) {
                const timestamp = Date.now();
                // Main Image (Medium)
                const mainSrc = `${IMAGE_BASE}/api/profile-picture/${activePic.id}/view/medium?token=${encodeURIComponent(token)}&ts=${timestamp}`;
                if (mainImg) {
                    mainImg.src = mainSrc;
                    mainImg.style.display = "block";
                }
                const mainAvatar = document.getElementById("profileMainAvatar");
                if (mainAvatar) mainAvatar.style.display = "none";

                // Sidebar Image (Small)
                const smallSrc = `${IMAGE_BASE}/api/profile-picture/${activePic.id}/view/small?token=${encodeURIComponent(token)}&ts=${timestamp}`;
                if (navImg) {
                    navImg.src = smallSrc;
                    navImg.style.display = "block";
                }
                if (navDiv) navDiv.style.display = "none";

                if (removeBtn) removeBtn.style.display = "inline-block";
                if (changeBtn) changeBtn.textContent = "Change Photo";
            } else {
                if (removeBtn) removeBtn.style.display = "none";
                if (changeBtn) changeBtn.textContent = "Set Profile Photo";

                // Clear main image to trigger fallback (if any)
                if (mainImg) mainImg.style.display = "none";
                const mainAvatar = document.getElementById("profileMainAvatar");
                if (mainAvatar) {
                    mainAvatar.textContent = getInitials(user.name);
                    mainAvatar.style.display = "flex";
                }

                // Sidebar Fallback
                if (navImg) navImg.style.display = "none";
                if (navDiv) navDiv.style.display = "flex";
            }
        }

        async function setActiveProfilePicture(id) {
            if (!confirm("Set this picture as your profile picture?")) return;

            try {
                const res = await fetch(`${IMAGE_BASE}/api/profile-picture/${id}/active`, {
                    method: "PUT",
                    headers: { "Authorization": "Bearer " + token }
                });

                if (res.ok) {
                    loadProfile(); // Refresh
                } else {
                    alert("Failed to update profile picture");
                }
            } catch (e) {
                console.error("Set active error", e);
            }
        }

        async function deleteProfilePicture() {
            if (!confirm("Are you sure you want to remove your current profile picture?")) return;
            try {
                const res = await fetch(`${IMAGE_BASE}/api/profile-picture`, {
                    method: "DELETE",
                    headers: { "Authorization": "Bearer " + token }
                });

                if (res.ok) {
                    alert("Profile picture removed");
                    loadProfile();
                } else {
                    alert("Failed to delete");
                }
            } catch (e) {
                console.error("Delete error", e);
            }
        }


        /* ================= POLLING ================= */
        let currentInboxState = "";

        function startGlobalPolling() {
            // Only poll for background updates occasionally (e.g. every 30 seconds)
            // Real-time updates are now handled by SSE (initGlobalNotifications)
            setInterval(() => {
                debouncedLoadInbox();
            }, 30000);
        }

        function initGlobalNotifications() {
            if (globalEventSource) globalEventSource.close();

            globalEventSource = new EventSource(
                `${CHAT_BASE}/api/sse/notifications?token=${encodeURIComponent(token)}`
            );

            globalEventSource.addEventListener("inbox_update", e => {
                const data = JSON.parse(e.data);
                console.log("Global notification received:", data);

                // Refresh inbox in real-time when a message arrives
                debouncedLoadInbox();

                // If it's for another chat, you could show a browser notification here
            });

            globalEventSource.addEventListener("read_update", e => {
                // When someone reads a message, refresh inbox to clear unread counts
                debouncedLoadInbox();
            });

            globalEventSource.onerror = (e) => {
                console.warn("Global SSE connection lost. Retrying in 5s...");
                globalEventSource.close();
                setTimeout(initGlobalNotifications, 5000);
            };
        }

        async function loadMessagesSilent(id) {
            try {
                const res = await fetch(`${CHAT_BASE}/api/conversations/${id}/messages`, {
                    headers: { "Authorization": "Bearer " + token }
                });
                if (res.ok) {
                    const msgs = await res.json();
                    // Only re-render if count changed (basic check)
                    const box = document.getElementById("messageList");
                    if (msgs.length !== box.children.length && msgs.length > 0) {
                        box.innerHTML = "";
                        msgs.reverse().forEach(renderMessage);
                        scrollToBottom();
                    } else if (box.children.length === 0 && msgs.length > 0) {
                        box.innerHTML = "";
                        msgs.reverse().forEach(renderMessage);
                        scrollToBottom();
                    }
                }
            } catch (e) { }
        }

        /* ================= INBOX ================= */
        // Debounce inbox loading to prevent flickering/spam during rapid updates
        let inboxLoading = false;
        async function debouncedLoadInbox() {
            if (inboxLoading) return;
            inboxLoading = true;
            try {
                await loadInbox();
            } finally {
                inboxLoading = false;
            }
        }

        /* ================= CHAT ================= */
        async function loadInbox() {
            try {
                const res = await fetch(`${CHAT_BASE}/api/inbox`, {
                    headers: { "Authorization": "Bearer " + token }
                });

                if (!res.ok) {
                    if (res.status === 401) {
                        // silent fail on poll
                        return;
                    }
                    return;
                }

                const inbox = await res.json();

                if (!Array.isArray(inbox)) {
                    return;
                }

                // SORTING: Newest message first
                // Ensure we handle missing timestamps gracefully
                inbox.sort((a, b) => {
                    const tA = a.lastMessageTimestamp ? new Date(a.lastMessageTimestamp).getTime() : 0;
                    const tB = b.lastMessageTimestamp ? new Date(b.lastMessageTimestamp).getTime() : 0;
                    return tB - tA;
                });

                currentInbox = inbox;
                renderInbox(inbox);

            } catch (e) {
                console.error("Inbox error", e);
            }
        }

        async function loadGroups() {
            // Simple cache/throttle: prevent reloading if < 10 seconds have passed
            const now = Date.now();
            const list = document.getElementById("groupList");
            if (list.hasChildNodes() && (now - lastGroupsLoadTime < 10000)) {
                return;
            }

            try {
                const res = await fetch(`${CHAT_BASE}/api/groups`, {
                    headers: { "Authorization": "Bearer " + token }
                });

                if (!res.ok) {
                    console.error("Group API error", res.status);
                    return;
                }

                const groups = await res.json();
                renderGroups(groups);
                lastGroupsLoadTime = Date.now();

            } catch (e) {
                console.error("Load groups error", e);
            }
        }


        function collectImages(fileList) {
            const images = [];

            for (const file of fileList) {
                if (!file.type.startsWith("image/")) continue;
                images.push(file);
            }

            return images;
        }

        function renderInbox(data) {
            // Deep compare with previous state to avoid redraw / blinking
            const newState = JSON.stringify(data.map(c => ({ id: c.conversationId, msg: c.lastMessage, unread: c.unreadCount })));
            if (newState === currentInboxState) {
                return;
            }
            currentInboxState = newState;

            const list = document.getElementById("conversationList");
            list.innerHTML = "";


            data.forEach(c => {
                const div = document.createElement("div");
                div.className = "conversation-item";

                const title =
                    c.otherUserName ||
                    c.groupName ||
                    c.username ||
                    c.name ||
                    "Unknown";
                const avatar = title[0].toUpperCase();

                div.onclick = () => openChat(c.conversationId);

                const isUnread = (c.unreadCount > 0) && (Number(c.conversationId) !== Number(activeConversationId));

                div.innerHTML = `
            <div class="user-avatar" style="background: #eee; display: flex; align-items: center; justify-content: center;">
                <img src="${IMAGE_BASE}/api/profile-picture/${(!isNaN(c.otherUserId) && c.otherUserId) ? c.otherUserId : (!isNaN(c.userId) ? c.userId : '0')}/small?token=${encodeURIComponent(token)}" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'" 
                     style="width:100%;height:100%;border-radius:50%;object-fit:cover;" />
                <div style="width:100%;height:100%;display:none;align-items:center;justify-content:center;font-weight:bold; font-size: 14px; color: #555;">
                    ${avatar}
                </div>
            </div>
            <div class="conv-info">
                <div class="conv-name">${title}</div>
                <div class="conv-preview">
                    ${c.lastMessage || "No messages"}
                </div>
            </div>
            ${isUnread
                        ? `<div class="badge success">${c.unreadCount}</div>`
                        : ""}
        `;

                // Group Styling
                if (c.type === 'GROUP') {
                    div.classList.add('group-item');
                    div.innerHTML = `
                    <div class="user-avatar">
                         <ion-icon name="people" style="font-size:24px; color: #0288d1;"></ion-icon>
                    </div>
                    <div class="conv-info">
                        <div class="conv-name">${title}</div>
                        <div class="conv-preview">
                            ${c.lastMessage || "No messages"}
                        </div>
                    </div>
                    ${isUnread ? `<div class="badge success">${c.unreadCount}</div>` : ""}
                    `;
                }

                list.appendChild(div);
            });
        }

        function renderGroups(groups) {
            const list = document.getElementById("groupList");
            list.innerHTML = "";

            groups.forEach(g => {
                const div = document.createElement("div");
                div.className = "conversation-item";

                // âœ… THIS is where openGroupChat belongs
                div.onclick = () => openGroupChat(
                    g.conversationId,
                    g.groupName
                );

                div.innerHTML = `
            <div class="user-avatar group-avatar">
                                        <ion-icon name="people" style="font-size:24px; color: #0288d1;"></ion-icon>

            </div>
            <div class="conv-info">
                <div class="conv-name">${g.groupName}</div>
                <div class="conv-preview">
                    ${g.lastMessage || "No messages"}
                </div>
            </div>
        `;
                list.appendChild(div);
            });
        }


        function openGroupChat(conversationId, groupName) {

            // Switch properly to chat view
            switchView("chat", document.querySelectorAll(".nav-item")[1]);

            // Set group name immediately
            document.getElementById("chatHeaderName").textContent = groupName;

            // Open chat
            // Open chat
            openChat(conversationId);
            // Open chat
            openChat(conversationId);
            updateChatHeaderAvatar(0, groupName); // Assuming groups don't have avatars yet, or passed differently

            fetch(`${CHAT_BASE}/api/conversations/${conversationId}/details`, {
                headers: { "Authorization": "Bearer " + token }
            })
                .then(res => res.json())
                .then(details => {
                    if (!details.members || !Array.isArray(details.members)) {
                        console.error("Invalid group details response", details);
                        return;
                    }

                    const names = details.members.map(m => m.name).join(", ");
                    document.getElementById("chatHeaderMembers").textContent = names;


                    if (details.admin === true) {
                        document.getElementById("addMemberBtn").classList.remove("hidden");
                    }
                })

                .catch(err => {
                    console.error("Failed to load group details", err);
                });

        }


        async function startSync() {

            const picker = document.getElementById("folderPicker");
            const status = document.getElementById("syncStatus");

            if (!picker.files || picker.files.length === 0) {
                status.textContent = "Please select a folder first";
                return;
            }

            const images = collectImages(picker.files);

            if (!images.length) {
                status.textContent = "No images found in folder";
                return;
            }

            const formData = new FormData();

            images.forEach(file => {
                formData.append("files", file);
            });

            status.textContent = "Syncing images...";

            const res = await fetch(`${IMAGE_BASE}/api/images/bulk`, {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + token
                },
                body: formData
            });

            if (!res.ok) {
                status.textContent = "Sync failed (invalid files found)";
                return;
            }

            const savedImages = await res.json();

            status.textContent = `Synced ${savedImages.length} images`;

            // Reload all images to show complete gallery
            loadImages();
        }

        async function loadImages() {
            const res = await fetch(`${IMAGE_BASE}/api/images?size=50`, {
                headers: {
                    "Authorization": "Bearer " + token
                }
            });

            const page = await res.json();
            renderImages(page.content);
        }


        async function openChat(id) {
            activeConversationId = id;

            document.getElementById("inputArea").classList.remove("hidden");
            const input = document.getElementById("messageInput");
            if (input) {
                input.value = "";
                input.style.height = 'auto'; // Reset height if auto-expanded
                input.focus();
            }

            document.getElementById("emptyState")?.remove();

            if (window.innerWidth <= 768) {
                document.getElementById("chatMain").classList.add("active");
            }

            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }

            const convo = currentInbox.find(c => c.conversationId === id);
            activeConversationType = convo ? convo.type : null;

            if (convo) {
                if (convo.type === "PRIVATE" && convo.otherUserName) {
                    document.getElementById("chatHeaderName").textContent = convo.otherUserName;
                    // Find header avatar
                    updateChatHeaderAvatar(convo.otherUserId, convo.otherUserName);

                    document.getElementById("chatHeaderMembers").textContent = "";
                    document.getElementById("addMemberBtn").classList.add("hidden");
                } else if (convo.type === "GROUP") {
                    document.getElementById("chatHeaderName").textContent = convo.groupName;
                    // Use '0' and pass generic flag if needed, but for now specific styling in updateChatHeaderAvatar
                    updateChatHeaderAvatar(0, convo.groupName, true); // true = isGroup

                    fetchGroupDetails();
                }
            }


            const res = await fetch(
                `${CHAT_BASE}/api/conversations/${id}/messages`,
                {
                    headers: {
                        "Authorization": "Bearer " + token
                    }
                }
            );

            await fetch(`${CHAT_BASE}/api/conversations/${id}/read`, {
                method: "POST",
                headers: { "Authorization": "Bearer " + token }
            });

            const msgs = await res.json();
            const box = document.getElementById("messageList");
            box.innerHTML = "";
            lastDate = null; // Reset date tracking
            msgs.reverse().forEach(renderMessage);
            scrollToBottom();

            /* ===== SSE ===== */
            eventSource = new EventSource(
                `${CHAT_BASE}/api/sse/conversations/${id}?token=${encodeURIComponent(token)}`
            );


            eventSource.onmessage = (e) => {
                const msg = JSON.parse(e.data);

                // Only render if this message belongs to the ACTIVE conversation
                if (activeConversationId && Number(msg.conversationId) === Number(activeConversationId)) {
                    renderMessage(msg);
                    scrollToBottom();

                    // Mark as read immediately since we are viewing it
                    if (!document.hidden) {
                        fetch(`${CHAT_BASE}/api/conversations/messages/${msg.messageId}/read`, {
                            method: "POST",
                            headers: { "Authorization": "Bearer " + token }
                        }).catch(() => { });
                    }
                }

                // Always refresh inbox to show new message preview / unread counts
                debouncedLoadInbox();
            };

            eventSource.addEventListener("typing", e => {
                const data = JSON.parse(e.data);
                // Fix: Ensure we compare numbers
                if (Number(data.userId) === Number(user.userId || user.id)) return;

                const el = document.getElementById("typingIndicator");
                if (el) {
                    el.textContent = `${data.username} is typing...`;
                    el.classList.remove("hidden");

                    // Clear previous timeout if exists
                    if (el.dataset.timeout) clearTimeout(el.dataset.timeout);

                    const timeout = setTimeout(() => el.classList.add("hidden"), 3000);
                    el.dataset.timeout = timeout;
                }
            });

            eventSource.addEventListener("error", (e) => {
                console.error("SSE error", e);
                eventSource.close();
            });


            eventSource.addEventListener("read", e => {
                const data = JSON.parse(e.data);

                // Find message element by data-message-id
                const msgEl = document.querySelector(
                    `.message-row[data-message-id="${data.messageId}"]`
                );

                if (msgEl) {
                    // Update the tick to blue double-tick for MY messages
                    if (msgEl.classList.contains("right")) {
                        const timeEl = msgEl.querySelector(".message-time");
                        if (timeEl) {
                            // Convert existing checkmark or add one
                            let icon = timeEl.querySelector("ion-icon");
                            if (!icon) {
                                icon = document.createElement("ion-icon");
                                icon.classList.add("read-tick");
                                timeEl.appendChild(icon);
                            }
                            icon.setAttribute("name", "checkmark-done"); // Solid double tick
                            icon.classList.add("seen"); // Triggers CSS blue color
                            icon.style.color = "#4dabf7";
                        }
                    }
                }
            });

            // Re-render inbox to update active state
            debouncedLoadInbox();

            // Auto-focus message input (desktop only)
            if (window.innerWidth > 768) {
                setTimeout(() => {
                    const input = document.getElementById("messageInput");
                    if (input) input.focus();
                }, 100);
            }
        }

        // ================= DEBOUNCE =================
        function debouncedLoadInbox() {
            if (inboxDebounceTimer) clearTimeout(inboxDebounceTimer);
            inboxDebounceTimer = setTimeout(() => {
                loadInbox();
            }, 1000); // Wait 1 second before refreshing inbox
        }

        function handleChatInputKey(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        // ...

        /* ================= ADD MEMBER ================= */
        let addMemberTimeout;
        let lastGroupsLoadTime = 0; // Cache timestamp



        function toggleAddMemberSearch(event) {
            if (event) event.stopPropagation();
            const box = document.getElementById("addMemberBox");
            if (box.classList.contains("hidden")) {
                box.classList.remove("hidden");
                document.getElementById("addMemberInput").focus();
            } else {
                box.classList.add("hidden");
                document.getElementById("addMemberInput").value = "";
                document.getElementById("addMemberResults").innerHTML = "";
            }
        }

        document.getElementById("addMemberInput").addEventListener("input", (e) => {
            const q = e.target.value.trim();
            clearTimeout(addMemberTimeout);

            if (q.length < 2) {
                document.getElementById("addMemberResults").innerHTML = "";
                return;
            }

            addMemberTimeout = setTimeout(() => {
                fetch(`${CHAT_BASE}/api/conversations/users/search?q=${encodeURIComponent(q)}`, {
                    headers: { "Authorization": "Bearer " + token }
                })
                    .then(res => res.json())
                    .then(renderAddMemberResults)
                    .catch(err => console.error("User search error", err));
            }, 300);
        });

        function renderAddMemberResults(users) {
            const box = document.getElementById("addMemberResults");
            box.innerHTML = "";

            if (users.length === 0) {
                box.innerHTML = "<div style='color:gray;font-size:12px;padding:8px;'>No users found</div>";
                return;
            }

            users.forEach(u => {
                const div = document.createElement("div");
                div.className = "conversation-item";
                div.style.padding = "8px";
                div.style.borderBottom = "1px solid var(--border-color)";

                div.innerHTML = `
                    <div class="user-avatar" style="width:32px;height:32px; background: #eee; display: flex; align-items: center; justify-content: center;">
                        <img src="${IMAGE_BASE}/api/profile-picture/${!isNaN(u.userId) ? u.userId : '0'}/small?token=${encodeURIComponent(token)}" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'" 
                             style="width:100%;height:100%;border-radius:50%;object-fit:cover;" />
                        <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-weight:bold; font-size: 10px; color: #555; display: none;">
                            ${getInitials(u.name)}
                        </div>
                    </div>
                    <div style="flex:1; font-weight:500; margin-left:10px;">${u.name}</div>
                    <button class="btn btn-primary" style="font-size:10px;padding:4px 8px;" onclick="addMemberToGroup(${u.userId})">Add</button>
                `;
                box.appendChild(div);
            });
        }

        function addMemberToGroup(userId) {
            fetch(`${CHAT_BASE}/api/conversations/${activeConversationId}/members`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify({ userId })
            })
                .then(res => {
                    if (!res.ok) throw new Error("Failed");
                    toggleAddMemberSearch(); // Close box
                    return fetchGroupDetails();
                })
                .catch(() => alert("Failed to add member"));
        }

        function fetchGroupDetails() {
            fetch(`${CHAT_BASE}/api/conversations/${activeConversationId}/details`, {
                headers: { "Authorization": "Bearer " + token }
            })
                .then(res => res.json())
                .then(details => {
                    if (!details.members) return;
                    const names = details.members.map(m => m.name).join(", ");
                    document.getElementById("chatHeaderMembers").textContent = names;

                    if (details.admin === true) {
                        document.getElementById("addMemberBtn").classList.remove("hidden");
                    } else {
                        document.getElementById("addMemberBtn").classList.add("hidden");
                    }
                });
        }

        function renderMessage(msg) {
            const box = document.getElementById("messageList");

            // ---- DATE SEPARATOR LOGIC ----
            if (msg.createdTimestamp) {
                const date = new Date(msg.createdTimestamp);
                const dateKey = date.toDateString(); // e.g. "Fri Jan 20 2026"

                if (lastDate !== dateKey) {
                    const separator = document.createElement("div");
                    separator.className = "date-separator";

                    // Format: Today, Yesterday, or Jan 20, 2024
                    separator.innerText = getFriendlyDate(date);
                    box.appendChild(separator);

                    lastDate = dateKey;
                }
            }

            // Robust ID check
            const myId = user.userId || user.id;
            const isMe = Number(msg.senderId) === Number(myId);

            const row = document.createElement("div");
            row.className = `message-row ${isMe ? "right" : "left"}`;
            // ...
            row.dataset.messageId = msg.messageId;

            const bubble = document.createElement("div");
            bubble.className = "message-bubble";

            // Content
            bubble.innerHTML = "";
            if (!isMe && activeConversationType === "GROUP" && msg.senderName) {
                const nameEl = document.createElement("div");
                nameEl.style.fontSize = "11px";
                nameEl.style.color = "#d66a00"; // Distinct color for names (e.g. orange-ish or just muted)
                nameEl.style.marginBottom = "2px";
                nameEl.style.fontWeight = "600";
                nameEl.innerText = msg.senderName;
                bubble.appendChild(nameEl);
            }
            bubble.appendChild(document.createTextNode(msg.content));

            // Avatar for incoming messages
            if (!isMe) {
                const avatarContainer = document.createElement("div");
                avatarContainer.className = "chat-avatar";
                const senderId = msg.senderId || '0';

                avatarContainer.style.width = "28px";
                avatarContainer.style.height = "28px";
                avatarContainer.style.borderRadius = "50%";
                avatarContainer.style.marginRight = "8px";
                avatarContainer.style.overflow = "hidden";
                avatarContainer.style.flexShrink = "0";

                const initial = getInitials(msg.senderName || "?");
                avatarContainer.innerHTML = `
                    <img src="${IMAGE_BASE}/api/profile-picture/${!isNaN(senderId) ? senderId : '0'}/small?token=${encodeURIComponent(token)}"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"
                         style="width:100%;height:100%;object-fit:cover;" />
                    <div style="width:100%;height:100%;background:#eee;display:none;align-items:center;justify-content:center;font-size:10px;font-weight:bold;color:#555;">
                        ${initial}
                    </div>
                 `;

                // Fix: Append avatar FIRST, then bubble
                row.style.alignItems = "flex-end";
                row.appendChild(avatarContainer);
            }

            row.appendChild(bubble);

            // Time
            if (msg.createdTimestamp) {
                const date = new Date(msg.createdTimestamp);
                // 24-hour format
                const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });

                const timeEl = document.createElement("span");
                timeEl.className = "message-time";

                // If it's me, showing ticks
                let statusIcon = "";
                if (isMe) {
                    if (msg.read) {
                        statusIcon = ` <ion-icon name="checkmark-done" class="read-tick seen" style="color:#4dabf7 !important;"></ion-icon>`;
                    } else {
                        statusIcon = ` <ion-icon name="checkmark-outline" class="read-tick"></ion-icon>`;
                    }
                }

                timeEl.innerHTML = `${timeStr}${statusIcon}`;
                bubble.appendChild(timeEl);
            }

            // Removing external "Sent" status as requested
            // if (isMe) { ... }

            box.appendChild(row);
            box.scrollTop = box.scrollHeight;
        }

        function getFriendlyDate(date) {
            const today = new Date();
            const yesterday = new Date();
            yesterday.setDate(today.getDate() - 1);

            if (date.toDateString() === today.toDateString()) {
                return "Today";
            } else if (date.toDateString() === yesterday.toDateString()) {
                return "Yesterday";
            } else {
                return date.toLocaleDateString([], { day: 'numeric', month: 'short', year: 'numeric' });
            }
        }

        function scrollToBottom() {
            const box = document.getElementById("messageList");
            if (box) box.scrollTop = box.scrollHeight;
        }

        /* ================= TYPING ================= */
        let typingTimeout;

        document.getElementById("messageInput").addEventListener("input", function () {
            if (!activeConversationId) return;

            // Auto-resize
            this.style.height = 'auto';
            const newHeight = Math.min(this.scrollHeight, 120);
            this.style.height = newHeight + 'px';

            fetch(`${CHAT_BASE}/api/conversations/${activeConversationId}/typing`, {
                method: "POST",
                headers: { "Authorization": "Bearer " + token }
            });

            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                const el = document.getElementById("typingIndicator");
                if (el) el.classList.add("hidden");
            }, 3000);
        });

        /* ================= SEND ================= */
        async function sendMessage() {
            const input = document.getElementById("messageInput");
            const text = input.value.trim();
            if (!text || !activeConversationId) return;

            await fetch(`${CHAT_BASE}/api/conversations/${activeConversationId}/messages`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify({ content: text })
            });

            input.value = "";
            input.style.height = 'auto'; // Reset height after sending
        }


        async function loadImages() {
            try {
                const res = await fetch(`${IMAGE_BASE}/api/images?size=50`, {
                    headers: {
                        "Authorization": "Bearer " + token
                    }
                });

                if (!res.ok) {
                    console.error("Failed to load images", res.status);
                    return;
                }

                const page = await res.json();
                renderImages(page.content);

            } catch (e) {
                console.error("Image load error", e);
            }
        }

        function renderImages(images) {
            const grid = document.getElementById("imageGrid");
            grid.innerHTML = "";

            images.forEach(img => {
                const wrapper = document.createElement("div");
                wrapper.className = "image-wrapper";

                const el = document.createElement("img");
                el.src = `${IMAGE_BASE}/api/images/${img.id}/thumbnail?token=${encodeURIComponent(token)}`;
                el.onclick = () => openImageModal(img.id);

                const trash = document.createElement("span");
                trash.className = "trash-icon";
                trash.innerHTML = "<ion-icon name='trash-outline'></ion-icon>";
                trash.onclick = (e) => {
                    e.stopPropagation();
                    deleteImage(img.id);
                };

                wrapper.appendChild(el);
                wrapper.appendChild(trash);
                grid.appendChild(wrapper);
            });
        }

        function openImageModal(imageId) {
            const modal = document.getElementById("imageModal");
            const img = document.getElementById("modalImage");

            img.src = `${IMAGE_BASE}/api/images/${imageId}/download?token=${encodeURIComponent(token)}`;
            modal.classList.remove("hidden");
        }

        function closeImageModal() {
            document.getElementById("imageModal").classList.add("hidden");
        }

        // Open Profile Picture in Modal
        function openProfileImageModal() {
            if (!currentChatOtherUserId || currentChatOtherUserId === 0) return;

            const modal = document.getElementById("imageModal");
            const img = document.getElementById("modalImage");
            const fallback = document.getElementById("modalImageFallback");

            // Reset states
            if (img) img.style.display = "none";
            if (fallback) fallback.style.display = "none";

            if (img && fallback) {
                // Set up error handler BEFORE setting src
                img.onerror = () => {
                    img.style.display = "none";
                    fallback.style.display = "flex";
                    fallback.textContent = "No profile picture";
                };

                img.onload = () => {
                    img.style.display = "block";
                    fallback.style.display = "none";
                };

                // Add timestamp to prevent caching
                img.src = `${IMAGE_BASE}/api/profile-picture/${currentChatOtherUserId}/medium?token=${encodeURIComponent(token)}&t=${Date.now()}`;
            }

            modal.classList.remove("hidden");
        }

        async function uploadImages() {
            const input = document.getElementById("imageUploadInput");
            if (!input.files.length) return;

            const formData = new FormData();
            for (const file of input.files) {
                formData.append("files", file);
            }

            const res = await fetch(`${IMAGE_BASE}/api/images/bulk`, {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + token
                },
                body: formData
            });

            if (res.ok) {
                loadImages();
                input.value = "";
            } else {
                alert("Bulk upload failed");
            }
        }

        /* ================= PROFILE PICTURE ================= */

        async function uploadProfile() {
            const f = document.getElementById("profileInput").files[0];
            if (!f) return;

            const fd = new FormData();
            fd.append("file", f);

            const res = await fetch(`${IMAGE_BASE}/api/profile-picture`, {
                method: "POST",
                headers: { "Authorization": "Bearer " + token },
                body: fd
            });

            if (res.ok) {
                loadProfilePicture();
            } else {
                alert("Failed to upload profile picture");
            }
        }

        async function deleteProfilePicture() {
            if (!confirm("Remove profile picture?")) return;

            const res = await fetch(`${IMAGE_BASE}/api/profile-picture`, {
                method: "DELETE",
                headers: { "Authorization": "Bearer " + token }
            });

            if (res.ok) {
                loadProfile(); // Refresh profile view
                loadProfilePicture(); // Refresh sidebar/nav
            } else {
                alert("Failed to remove profile picture");
            }
        }

        async function loadProfilePicture() {
            // 1. Sidebar - Use history API to check if profile picture exists
            const navImg = document.getElementById("navAvatarImg");
            const navLetter = document.getElementById("navAvatar");
            if (navImg && navLetter) {
                // Force reset to initials first
                navImg.style.display = "none";
                navImg.src = ""; // Clear src to prevent caching
                navLetter.style.display = "flex";

                try {
                    // Check profile history to see if there's an active picture
                    const historyResponse = await fetch(`${IMAGE_BASE}/api/profile-picture/history`, {
                        headers: {
                            'Authorization': 'Bearer ' + token,
                            'Cache-Control': 'no-cache'
                        }
                    });

                    if (historyResponse.ok) {
                        const pics = await historyResponse.json();
                        const activePic = pics.find(p => p.active);

                        if (activePic) {
                            // Active picture exists, load it
                            const imageUrl = `${IMAGE_BASE}/api/profile-picture/small?token=${encodeURIComponent(token)}&t=${Date.now()}`;
                            navImg.onload = () => {
                                navImg.style.display = "block";
                                navLetter.style.display = "none";
                            };
                            navImg.onerror = () => {
                                navImg.style.display = "none";
                                navLetter.style.display = "flex";
                            };
                            navImg.src = imageUrl;
                        } else {
                            // No active picture, show initials
                            navImg.style.display = "none";
                            navLetter.style.display = "flex";
                        }
                    } else {
                        // Error fetching history, show initials
                        navImg.style.display = "none";
                        navLetter.style.display = "flex";
                    }
                } catch (error) {
                    console.error("Error loading profile picture:", error);
                    // On error, show initials
                    navImg.style.display = "none";
                    navLetter.style.display = "flex";
                }
            }

            // 2. Profile View
            const profileImg = document.getElementById("profileImg");
            if (profileImg) {
                // Remove onerror attribute to handle via JS
                profileImg.removeAttribute("onerror");

                profileImg.onerror = () => {
                    // Fallback to a styled div or a placeholder image
                    profileImg.src = "https://ui-avatars.com/api/?name=User&background=random&size=200";
                };
                profileImg.src = `${IMAGE_BASE}/api/profile-picture/medium?token=${encodeURIComponent(token)}&t=${Date.now()}`;
            }
        }


        async function deleteImage(imageId) {
            if (!confirm("Delete this image?")) return;

            const res = await fetch(`${IMAGE_BASE}/api/images/${imageId}`, {
                method: "DELETE",
                headers: {
                    "Authorization": "Bearer " + token
                }
            });

            if (res.ok) {
                loadImages(); // refresh grid
            } else {
                alert("Delete failed");
            }
        }

        // Global variable to store current chat user ID for modal
        let currentChatOtherUserId = 0;

        function updateChatHeaderAvatar(userId, name, isGroup = false) {
            const img = document.getElementById("chatHeaderImg");
            const fb = document.getElementById("chatHeaderFallback");

            // Update global tracking ID
            currentChatOtherUserId = userId;

            if (!img || !fb) return;

            // Fallback logic for letter
            let initial = "#";
            if (name && name.length > 0) {
                initial = name[0].toUpperCase();
            }

            if (isGroup || !userId || Number(userId) === 0) {
                img.style.display = "none";
                fb.style.display = "flex";

                if (isGroup) {
                    fb.innerHTML = `<ion-icon name="people" style="font-size:20px;"></ion-icon>`;
                    fb.style.backgroundColor = "#e0f2fe";
                    fb.style.color = "#0288d1";
                } else {
                    fb.textContent = initial;
                    fb.style.backgroundColor = (name && name !== "Unknown") ? "#e0f2fe" : "#eee";
                    fb.style.color = (name && name !== "Unknown") ? "#0288d1" : "black";
                }

                return;
            }

            // Reset to fallback first
            img.style.display = "none";
            fb.style.display = "flex";
            fb.textContent = initial;

            img.onload = () => {
                img.style.display = "block";
                fb.style.display = "none";
            };
            img.onerror = () => {
                img.style.display = "none";
                fb.style.display = "flex";
                fb.textContent = initial;
            };

            img.src = `${IMAGE_BASE}/api/profile-picture/${(!isNaN(userId) && userId !== 0) ? userId : '0'}/small?token=${encodeURIComponent(token)}`;
        }

        async function loadProfilePictureStatus() {
            try {
                const res = await fetch(`${IMAGE_BASE}/api/profile-picture/history`, {
                    headers: { "Authorization": "Bearer " + token }
                });
                const statusText = document.getElementById("profilePicStatusText");
                if (res.ok) {
                    const pics = await res.json();
                    const activeP = pics.find(p => p.active);
                    if (statusText) {
                        statusText.textContent = activeP ? "" : "No profile picture set";
                        statusText.style.color = activeP ? "#28a745" : "#8e8e8e";
                    }
                } else {
                    if (statusText) statusText.textContent = "No profile picture set";
                }
            } catch (e) {
                console.error(e);
            }
        }

        /* ================= NEW CHAT ================= */

        let searchTimeout;

        // Show search box
        function startNewChat(event) {
            if (event) event.stopPropagation();
            const box = document.getElementById("newChatBox");
            box.classList.remove("hidden");
            document.getElementById("userSearchInput").focus();
        }

        // Search users while typing
        document.getElementById("userSearchInput").addEventListener("input", (e) => {
            const q = e.target.value.trim();
            clearTimeout(searchTimeout);

            if (q.length < 2) {
                document.getElementById("userSearchResults").innerHTML = "";
                return;
            }

            searchTimeout = setTimeout(() => {
                fetch(`${CHAT_BASE}/api/conversations/users/search?q=${encodeURIComponent(q)}`, {
                    headers: {
                        "Authorization": "Bearer " + token
                    }
                })
                    .then(res => res.json())
                    .then(renderUserSearchResults)
                    .catch(err => console.error("User search error", err));
            }, 300);
        });

        // Render results
        function renderUserSearchResults(users) {
            const box = document.getElementById("userSearchResults");
            box.innerHTML = "";

            if (users.length === 0) {
                box.innerHTML = "<div style='color:gray;font-size:12px;padding:8px;'>No user found</div>";
                return;
            }

            users.forEach(u => {
                const div = document.createElement("div");
                div.className = "conversation-item";

                div.innerHTML = `
                    <div class="user-avatar" style="width:32px;height:32px; background: #eee; display: flex; align-items: center; justify-content: center;">
                        <img src="${IMAGE_BASE}/api/profile-picture/${!isNaN(u.userId) ? u.userId : '0'}/small?token=${encodeURIComponent(token)}" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'" 
                             style="width:100%;height:100%;border-radius:50%;object-fit:cover;" />
                        <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-weight:bold; font-size: 10px; color: #555; display: none;">
                            ${(u.name || "U")[0].toUpperCase()}
                        </div>
                    </div>
                    <div style="font-weight:500; margin-left:10px;">${u.name}</div>
                `;

                div.onclick = () => startPrivateChat(u.userId);

                box.appendChild(div);
            });
        }

        // Create or open private chat
        async function startPrivateChat(userId) {
            try {
                const res = await fetch(`${CHAT_BASE}/api/conversations`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify({
                        type: "PRIVATE",
                        participantUserId: userId
                    })
                });

                if (!res.ok) {
                    alert("Failed to create conversation");
                    return;
                }

                const data = await res.json();

                document.getElementById("userSearchResults").innerHTML = "";
                document.getElementById("userSearchInput").value = "";
                document.getElementById("newChatBox").classList.add("hidden");

                openChat(data.conversationId);

            } catch (e) {
                console.error("Create chat error", e);
            }
        }


        function closeMobileChat() {
            document.getElementById("chatMain").classList.remove("active");
        }
    </script>

</body>

</html>